version: 2

references:
  container_config: &container_config
    docker:
      - image: circleci/node:lts
    working_directory: ~/ant-design-icons

  attach_workspace: &attach_workspace
    attach_workspace:
      at: ~/ant-design-icons

  workflow: &workflow
    jobs:
      - setup:
          filters:
            branches:
              ignore: gh-pages
      - icons-svg:
          requires:
          - setup
      - icons-react:
          requires:
          - setup
          - icons-svg
      - icons-angular:
          requires:
          - setup
          - icons-svg
      - icons-vue:
          requires:
          - setup
          - icons-svg
      - icons-react-native:
          requires:
          - setup
          - icons-svg

jobs:
  setup:
    <<: *container_config
    steps:
      - checkout
      - run: node -v
      - run: yarn -v
      - run: yarn
      - run: yarn bootstrap
      - run:
          command: |
            set +eo
            yarn list
            true
      - persist_to_workspace:
          root: ~/ant-design-icons
          paths:
            - node_modules
            - packages/icons-*/node_modules

  icons-svg:
    <<: *container_config
    steps:
      - checkout
      - *attach_workspace
      - run: yarn icons:generate
      - run: yarn icons:build
      - run: yarn icons:test
      - persist_to_workspace:
          root: ~/ant-design-icons
          paths:
            - packages/icons-svg/es
            - packages/icons-svg/lib
            - packages/icons-svg/inline-svg

  icons-react:
    <<: *container_config
    steps:
      - checkout
      - *attach_workspace
      - run: yarn react:ci
  
  icons-angular:
    <<: *container_config
    steps:
      - checkout
      - *attach_workspace
      # CircleCI fails to run puppeteer because some dependencies are missing
      - run: sudo apt-get install gconf-service libasound2 libatk1.0–0 libc6 libcairo2 libcups2 libdbus-1–3 libexpat1 libfontconfig1 libgbm-dev libgcc1 libgconf-2–4 libgdk-pixbuf2.0–0 libglib2.0–0 libgtk-3–0 libnspr4 libpango-1.0–0 libpangocairo-1.0–0 libstdc++6 libx11–6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
      - run: yarn angular:ci

  icons-vue:
    <<: *container_config
    steps:
      - checkout
      - *attach_workspace
      - run: yarn vue:ci

  icons-react-native:
    <<: *container_config
    steps:
      - checkout
      - *attach_workspace
      - run: yarn react-native:ci

workflows:
  version: 2
  build_test:
    <<: *workflow
  nightly:
    <<: *workflow
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
